name: Make App Store Connect Release

on:
  push:
    branches: [ "jacek/match" ]

# on: 
#   workflow_dispatch:
#     inputs:
#       destination:
#         description: "Upload destination (TestFlight or App Store)"
#         required: true
#         default: appstore
#         type: choice
#         options:
#         - testflight
#         - appstore

jobs:
  make-release:

    runs-on: macos-12
    
    name: Make App Store Connect Release

    steps:

      - name: Register SSH keys for access to certificates
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_FASTLANE_MATCH }}

      - name: Check out the code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Decrypt the fonts
        env:
          FONTS_ENCRYPTION_KEY: ${{ secrets.FONTS_ENCRYPTION_KEY }}
        run: ./decrypt_fonts.sh

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_14.1.app/Contents/Developer

      - name: Prepare fastlane
        run: bundle install

      - name: Archive and upload the app
        env:
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_KEY_ISSUER: ${{ secrets.APPLE_API_KEY_ISSUER }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: bundle exec fastlane release_testflight